---
title: Batch Script 編碼規範和建議
version: 1.0.0
date: 2025-05-07
author: Robbin Lee
license: MIT
repository: https://github.com/robbin0919/Github_copilot
maintainers:
  - name: Robbin Lee
    email: robbin0919@domain.com
---

# Batch Script 編碼規範和建議

## 命名規範
- 使用有意義的檔案名稱，優先使用英文
- 批次檔副檔名使用 .bat 或 .cmd
- 變數名稱使用大寫字母，用底線分隔 (例如: USER_INPUT, FILE_PATH)
- 標籤名稱使用小寫字母，使用冒號結尾 (例如: :start_process:)

## 註解規範
- 在腳本開頭加入描述性註解，說明用途
- 重要區塊需加入區塊註解
- 使用 `rem` 或 `::` 作為註解標記

## 錯誤處理
- 使用 errorlevel 檢查命令執行狀態
- 加入錯誤處理機制
- 重要操作需要加入確認提示

## 錯誤處理詳解

### 1. ErrorLevel 檢查最佳實踐
```batch
rem 不建議使用
if !errorlevel! EQU 1 (
    echo 錯誤狀態檢查
)

rem 建議使用以下方式
if errorlevel 1 (
    echo 錯誤狀態檢查 - 適用於 >= 1 的情況
)

rem 精確檢查特定錯誤碼
if "!errorlevel!"=="1" (
    echo 錯誤狀態等於 1
)

rem 多重條件檢查 多重條件檢查
if errorlevel 2 (
    echo 錯誤等級 >= 2
) else if errorlevel 1 (
    echo 錯誤等級 = 1
) else (
    echo 執行成功
)
```

### 2. 錯誤狀態檢查範例
```batch
xcopy "source.txt" "dest.txt" >nul
if "!errorlevel!"=="0" (
    echo 複製成功
) else if "!errorlevel!"=="4" (
    echo 初始化錯誤
) else if "!errorlevel!"=="5" (
    echo 磁碟寫入錯誤
) else (
    echo 未知錯誤：!errorlevel!
)
```

### 3. 檔案操作錯誤處理
```batch
if exist "!FILE_PATH!" (
    del "!FILE_PATH!" 2>nul || (
        echo 無法刪除檔案
        exit /b 1
    )
)
```

### 4. 使用者確認機制
```batch
choice /c yn /m "是否繼續執行？"
if errorlevel 2 (
    echo 使用者取消操作
    exit /b 0
)
```

### 5. 錯誤碼定義
```batch
set "ERR_FILE_NOT_FOUND=1"
set "ERR_ACCESS_DENIED=2"
set "ERR_INVALID_INPUT=3"

if not exist "!INPUT_FILE!" (
    echo 錯誤：找不到檔案
    exit /b !ERR_FILE_NOT_FOUND!
)
```

### 6. 錯誤日誌記錄
```batch
call :log_error "操作失敗：!errorlevel!"
goto :eof

:log_error
    echo [%date% %time%] ERROR: %~1 >> error.log
    exit /b
```

## 語法標準

### 避免巢狀條件檢查
- 減少使用多層 if-else 結構
- 優先使用 goto 和子程序處理複雜條件
- 善用早期返回（early return）pattern

#### 不建議的寫法
```batch
if exist "!FILE!" (
    if "!USER!"=="admin" (
        if !COUNT! GTR 5 (
            echo 條件符合
        )
    )
)
```

#### 建議的寫法 1：使用 goto
```batch
if not exist "!FILE!" goto :check_failed
if not "!USER!"=="admin" goto :check_failed
if not !COUNT! GTR 5 goto :check_failed
echo 條件符合
goto :continue

:check_failed
echo 條件檢查失敗
exit /b 1

:continue
rem 繼續執行
```

#### 建議的寫法 2：使用子程序
```batch
call :check_conditions || (
    echo 條件檢查失敗
    exit /b 1
)
echo 條件符合

:check_conditions
    if not exist "!FILE!" exit /b 1
    if not "!USER!"=="admin" exit /b 1
    if not !COUNT! GTR 5 exit /b 1
    exit /b 0
```

### 優點
1. 提高程式碼可讀性
2. 降低邏輯錯誤風險
3. 方便維護和除錯
4. 減少重複程式碼

## 程式結構範例
```batch
@echo off
setlocal enabledelayedexpansion

rem === 腳本說明 ===
rem 檔案名稱：example.cmd
rem 用途：示範標準語法
rem 建立日期：%date%
rem 作者：

rem === 變數宣告 ===
set "INPUT_FILE=%~1"
set "OUTPUT_DIR=%~dp0output"
set /a "COUNTER=0"

rem === 主要程式 ===
:main
    if not exist "!INPUT_FILE!" (
        echo 錯誤：找不到輸入檔案 >con
        exit /b 1
    )
    
    mkdir "!OUTPUT_DIR!" 2>nul
    
    for /f "tokens=* delims=" %%a in (!INPUT_FILE!) do (
        set /a "COUNTER+=1"
        echo 處理第 !COUNTER! 行... >con
    )
    goto :eof

rem === 子程序 ===
:sub_routine
    setlocal
    set "PARAM=%~1"
    rem 程式邏輯
    endlocal & exit /b
```

## 建議實踐
1. 使用 `@echo off` 關閉命令回顯
2. 使用 `setlocal` 限制變數範圍
3. 使用 `exit /b` 結束子程序
4. 使用 `goto :eof` 結束主程序
5. 重要檔案操作需要檢查檔案是否存在
6. 使用引號包覆路徑和變數，避免空格問題
7. 善用 `setlocal` 和 `endlocal` 管理變數範圍
8. 使用 `%~nx1` 取得檔名和副檔名
9. 使用 `%~dp0` 取得腳本所在目錄
10. 使用 `>con` 確保訊息顯示在控制台